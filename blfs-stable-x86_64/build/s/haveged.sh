#! /bin/bash

PRGNAME="haveged"

### Haveged
# Демон, который генерирует непредсказуемый поток случайных чисел в канал
# /dev/random

# http://www.linuxfromscratch.org/blfs/view/9.0/postlfs/haveged.html

# Home page: https://sourceforge.net/projects/haveged/
# Download:  https://downloads.sourceforge.net/haveged/haveged-1.9.2.tar.gz

# Required: no
# Optional: no

ROOT="/"
source "${ROOT}check_environment.sh"                  || exit 1
source "${ROOT}unpack_source_archive.sh" "${PRGNAME}" || exit 1
source "${ROOT}config_file_processing.sh"                 || exit 1

TMP_DIR="/tmp/pkg-${PRGNAME}-${VERSION}"
rm -rf "${TMP_DIR}"
mkdir -pv "${TMP_DIR}"

./configure \
    --prefix=/usr || exit 1

make || exit 1
# make check
make install
make install DESTDIR="${TMP_DIR}"

mkdir -pv    "/usr/share/doc/${PRGNAME}-${VERSION}"
mkdir -pv    "${TMP_DIR}/usr/share/doc/${PRGNAME}-${VERSION}"
cp -v README "/usr/share/doc/${PRGNAME}-${VERSION}"
cp -v README "${TMP_DIR}/usr/share/doc/${PRGNAME}-${VERSION}"

# установим скрипт /etc/rc.d/init.d/haveged для запуска демона при старте
# системы
HAVEGED="/etc/rc.d/init.d/haveged"
if [ -f "${HAVEGED}" ]; then
    mv "${HAVEGED}" "${HAVEGED}.old"
fi

(
    cd /root/blfs-bootscripts || exit 1
    make install-haveged
    make install-haveged DESTDIR="${TMP_DIR}"
)

config_file_processing "${HAVEGED}"

cat << EOF > "/var/log/packages/${PRGNAME}-${VERSION}"
# Package: ${PRGNAME} (daemon for generate stream of random numbers)
#
# Linux provides device interfaces (/dev/random and /dev/urandom) to a pool of
# random numbers collected from system interrupt service routines. On some
# systems, especially on those systems with high needs or limited user
# interaction, the standard collection mechanism cannot meet demand. In those
# cases, an adequate supply of random numbers can be maintained by feeding
# additional entropy into /dev/random pool via a file system interface. The
# haveged daemon was created to fulfill this function using random data
# generated by the HAVEGE algorithm.
#
# Home page: https://sourceforge.net/projects/${PRGNAME}/
# Download:  https://downloads.sourceforge.net/${PRGNAME}/${PRGNAME}-${VERSION}.tar.gz
#
EOF

source "${ROOT}/write_to_var_log_packages.sh" \
    "${TMP_DIR}" "${PRGNAME}-${VERSION}"

echo -e "\n---------------\nRemoving *.la files..."
remove-la-files.sh
echo "---------------"
