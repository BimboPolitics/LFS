# http://www.linuxfromscratch.org/lfs/view/9.0/chapter08/grub.html
# https://wiki.archlinux.org/index.php/GRUB_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)

GRUB использует собственную структуру имен для дисков и разделов в виде
(hdN, M), где
    N - номер жесткого диска (отсчет с нуля)
    M - номер раздела (отсчет с единицы для primary и с 5 - для extended
        разделов).
    Например:
        /dev/sda1 - (hd0,1)
        /dev/sdb3 - (hd1,3).

GRUB, в отличие от Linux не считает приводы CD-ROM жесткими дисками, поэтому
если hda - первый жесткий диск, hdb - компакт-диск и hdc - второй жесткий диск,
то hdc будет (hd1)

Данные GRUB находятся в /boot/grub, но расположение загрузочного раздела - это
пользовательский выбор. Рекомендуется выделять для этого отдельный раздел
(~100M) на жестком диске.

Конфиг GRUB
===========
Главный файл конфигурации /boot/grub/grub.cfg

В целях защиты главного конфига от его перезаписи, например при обновлении
пакета Grub, в /boot/grub/grub.cfg можно оставить только одну строку со ссылкой
на другой файл, например menu.cfg и в дальнейшем вместо grub.cfg править только
menu.cfg Нужно обязательно указывать переменную $prefix. Если указать полный
путь как /boot/grub/menu.cfg, то система не загрузится.

# /boot/grub/menu.cfg
. $prefix/menu.cfg

Создадим menu.cfg с помощью автоматического конфигуратора
    # grub-mkconfig -o /boot/grub/menu.cfg

Команда 'grub-mkconfig' без параметров выводит конфиг на стандартный вывод
и не применяет никаких изменений. Такой конфиг получается громоздок и неудобен
для редактирования. Так же эта команда перезапишет существующий конфиг. Для
автоматического генерирования используется набор скриптов в /etc/grub.d/, но
эти сценарии не рекомендуются для LFS. Параметры автоконфигуратора описываются
в /etc/default/grub

Ручное конфигурирование более читабельно и удобно. Запишем в
/boot/grub/menu.cfg
# |-sda5    part /boot
# |-sda7    part /
# |-sda10   part /mnt/lfs
#------------------------------------------------------------------
# Begin /boot/grub/menu.cfg

# пункт меню по умолчанию
set default=0
# задержка перед автозапуском при неактивности пользователя (сек)
set timeout=7

# раздел /boot
set root=(hd0,5)

menuentry "GNU/Linux, Linux-5.5.15-lfs-stable" {
    # в качестве /boot используется /dev/sda5, поэтому указываем /kernel-name
    # в параметре root= указываем корневой раздел LFS системы, который
    # монтируется в режиме read-only
    linux /vmlinuz-lfs-5.5.15 root=/dev/sda10 ro
}

# End /boot/grub/menu.cfg
#------------------------------------------------------------------

Затем защитим от записи основной конфиг на уровне файловой системы присвоив ему
атрибут 'immutable'
    # chattr +i /boot/grub/grub.cfg
    Если потребуется, снять блокировку можно командой
    # chattr -i /boot/grub/grub.cfg
    Вывести все атрибуты файла
    # lsattr /boot/grub/grub.cfg

Установим файлы GRUB и перезапишем загрузочную запись (MBR), после чего можно
перезапускать систему
    # grub-install /dev/sda
    если при выполнении команды происходит ошибка, то добавим парамтр --recheck
    # grub-install --recheck /dev/sda

Дополнительно:
=============
Для автоматического обнаружения ОС отличных от Linux требуется пакет os-prober.
Если после установки пакета os-prober автоматическое обнаружение не работает
должным образом, то может потребоваться установка пакета hwinfo. Для отключения
автоматического обнаружения других операционных систем в /etc/default/grub
следует добавить строку GRUB_DISABLE_OS_PROBER="true"

Пользовательские пункты в меню GRUB определяются в /etc/grub.d/40_custom, либо
в /boot/grub/custom.cfg

# vim:ft=conf
